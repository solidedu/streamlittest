#!/bin/bash

# Define your bucket name, prefix, and download directory
BUCKET_NAME="datav"
PREFIX="fasdfsdfasdf/sdfhg"
DOWNLOAD_DIR="/var/snap/amazon-ssm-agent/23/files"

# Ensure the download directory exists
mkdir -p "$DOWNLOAD_DIR"

# Get the latest file information from S3
latest_file_info=$(/usr/local/bin/aws s3api list-objects-v2 \
    --bucket $BUCKET_NAME --prefix $PREFIX \
    --query 'Contents | sort_by(@, &LastModified)[-1].{Key: Key, LastModified: LastModified}' \
    --output json)

# Debug: Print the raw output to check what is returned
echo "Raw output from S3 query: $latest_file_info"

# Parse the key and timestamp from the JSON output
key=$(echo "$latest_file_info" | jq -r '.Key')
timestamp=$(echo "$latest_file_info" | jq -r '.LastModified')

# Debug: Print parsed values
echo "Parsed Key: $key"
echo "Parsed LastModified: $timestamp"

# Check if the key is empty or None
if [ -z "$key" ] || [ "$key" == "None" ]; then
    echo "Error: No valid key found."
    exit 1
fi

# Download the latest file from S3
/usr/local/bin/aws s3 cp "s3://$BUCKET_NAME/$key" "$DOWNLOAD_DIR"
if [ $? -ne 0 ]; then
    echo "Error: Failed to download the latest file from S3."
    exit 1
fi

# Log the downloaded file and timestamp
echo "$DOWNLOAD_DIR/$(basename $key) $timestamp" > latest_downloaded_file_with_timestamp.txt
echo "Latest file downloaded successfully: $key"
